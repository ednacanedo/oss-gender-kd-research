---
title: 'Gender Research: RQ1 Analysis'
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=5, fig.height=5, fig.path='figures/', dev=c('png', 'pdf'))

require(quanteda)
require(sqldf)
require(readtext)
require(wordcloud)
require(xtable)
require(plotrix)
require(gdata)
require(lattice)
require(Hmisc)
require(tidyverse)
setwd(".")
```


### (SETUP) Laod the datasets 

To answer RQ1, we use two datasets. 

   * all_commiters_ds: contains information about all commiters of the projects
   * tf_ds: contains information about all key developers of the projects


```{r}
all_commiters_ds <- read.csv("../datasets/all_committers_repo.csv", head=T, sep=",")
tf_ds <- read.csv("../datasets/tf.csv", head=T, sep=";")
colnames(all_commiters_ds)
colnames(tf_ds)
nrow(all_commiters_ds)
nrow(tf_ds)
summary(tf_ds$gender)
summary(tf_ds$gender2)
tf_ds$num_contributors <- as.numeric(gsub(",","",as.character(tf_ds$num_contributors)))
tf_ds$lines <- as.numeric(gsub(",","",as.character(tf_ds$lines)))
tf_ds$size <- as.numeric(gsub(",","",as.character(tf_ds$size)))
tf_ds$watchers <- as.numeric(gsub(",","",as.character(tf_ds$watchers)))
```

# Exploratory data analysis 

  * Number of distinct projects
  
```{r, echo=FALSE}
t1 <- sqldf("select count(distinct full_name) from tf_ds")
t1
```

   * Number of projects with at least 5 key developers
   
```{r, echo=FALSE}
t2 <- sqldf("select full_name, count(distinct login) totalTF 
       from tf_ds
       group by full_name 
       having totalTF >= 5 
       order by 2 desc")

head(t2,30)
nrow(t2)

nrow(t2) * 100 / t1
```

   * Characteristics of the projects 
   
```{r} 
projects_ds <- sqldf("select  full_name, lines, size, num_contributors, forks, watchers, count(distinct login) num_tf
                      from tf_ds 
                      group by full_name, lines, size, num_contributors, forks, watchers")

summary(projects_ds[,c("lines", "num_contributors", "size", "forks", "watchers")])
```
   
   * It is better to remove smaller projects

```{r}
tf_ds <- filter(tf_ds, lines >= 5183, tf_ds$num_contributors >= 33)

sqldf("select count(distinct full_name) from tf_ds")

projects_ds <- sqldf("select  full_name, lines, size, num_contributors, forks, watchers, count(distinct login) num_tf
                      from tf_ds 
                      group by full_name, lines, size, num_contributors, forks, watchers")

pds_summary <- as.data.frame(sapply(projects_ds[,c("lines", "num_contributors", "size", "forks", "watchers")], summary))

print(xtable(t(pds_summary)), type="latex")

```

   * Correlation: number of developers and number of TF developers
   * Correlation: lines of code and number of TF developers 


```{r}
t3 <- sqldf("select full_name, num_contributors, lines, count(*) ignore
             from tf_ds 
             group by full_name, num_contributors, lines 
             order by 3 desc")

nrow(t3)
head(t3)

t4 <- merge(t2, t3)
cor.test(as.numeric(t4$num_contributors), t4$totalTF, method="spearman")
cor.test(as.numeric(t4$lines), t4$totalTF, method="spearman")
```

   * Total number of key developers 
   
```{r}
distinct_tfs <- sqldf("select full_name, count(distinct login) total
                       from tf_ds 
                       group by full_name 
                       order by 2 desc")

nrow(distinct_tfs)
head(distinct_tfs, 50)
nrow(distinct_tfs[distinct_tfs$total>1, ])
```

#  (RQ1) How common are women key developers in OSS projects?

We answer this research question using an exploratory data analysis. 
We first report the characteristics of the projects (see table bellow). 

```{r, results="asis"}
ds_summary <- sqldf("select language, full_name, lines, num_contributors, forks, watchers, count(distinct login) num_tf
                    from tf_ds 
                    group by language, full_name, lines, num_contributors, forks, watchers")



nrow(ds_summary)

ds_summary_language <- sqldf("select language as 'Prog. Language', 
                                     avg(lines) as 'Average number of lines of code', 
                                     avg(num_contributors) as 'Average number of contributors', 
                                     avg(forks) as 'Average number of forks' ,
                                     avg(watchers) as 'Average number of watchers', 
                                     avg(num_tf) as 'Average number of key developers'
                              from ds_summary 
                              group by language 
                              order by 1")

print(xtable(ds_summary_language), type="html")
```

Next we present a histogram with the number of key developers per project. 

```{r hist}
plot(hist(ds_summary$num_tf))
```

Let's try to understand the women participation on OSS projects. 

```{r}
all_commiters_ds["gender_final"] <- 
  ifelse(trim(as.character(all_commiters_ds$gender)) == "", as.character("unisex"), as.character(all_commiters_ds$gender))

tf_ds["gender_final"] <- 
  ifelse(as.character(tf_ds$gender) != as.character(tf_ds$gender2), "unissex",  as.character(tf_ds$gender))

# note. we have to remove duplicated data

t_all_commiters <- sqldf("select name, gender_final, count(*) summaryCommiters
                          from all_commiters_ds 
                          group by name, gender_final 
                          order by 3 desc")


t_tf <- sqldf("select login, user, gender_final, count(*) summaryTF
                       from tf_ds 
                       group by login, user, gender_final 
                       order by 3 desc")




sqldf("select gender_final, count(*) total from all_commiters_ds group by gender_final")

sqldf("select gender_final, count(*) total from tf_ds group by gender_final")

slices <- c(21250, 12987, 208384)
lbls <- c("unissex", "female", "male")
pct <- round(slices/sum(slices)*100)
lbls <- paste(lbls, pct) # add percents to labels
lbls <- paste(lbls,"%",sep="") # ad % to labels

pie(slices, labels=lbls,explode=0.1,main="Pie Chart of Contributors")

slices <- c(195, 45, 1762)
lbls <- c("unissex", "female", "male")
pct <- slices/sum(slices)*100
lbls <- paste(lbls, pct) # add percents to labels
lbls <- paste(lbls,"%",sep="") # ad % to labels

pie(slices, labels=lbls,explode=0.1,main="Key developers")
```

That is, the percentage of women key developers is smaller then the percentage of 
women, when considering all contributors of the projects. 

Now, lets group the key developers by language and gender. 

```{r bp-language}
tf_language_female_only <- sqldf("select language, count(*) total_female 
                             from tf_ds 
                             where gender_final = 'female' 
                             group by language");

tf_language <- sqldf("select language, count(*) total
                             from tf_ds 
                             group by language")

res <- merge(tf_language, tf_language_female_only)
res["percent"] <- res$total_female * 100 / res$total

res <- res[order(res$percent), ]

barplot(res$percent, names.arg = res$language, las=2, ylab="Percentage", cex.axis = 0.7, ylim=range(pretty(c(0, res$percent))))

# dotplot(reorder(res$language, res$percent)~res$language)

# dotplot(res$percent~res$language, las=2)

# dotchart2(res$percent, labels=res$language, las=2, horizontal=F, sort.=T)
```


How many projects have at least one women key developer? 

```{r}
sqldf("select count(distinct full_name) total_projects 
                             from tf_ds 
                             where gender_final = 'female'");

sqldf("select count(distinct full_name) total_projects 
                             from tf_ds");

```

Table 1. 

```{r}
head(ds_summary, results='asis')

tab1<- sqldf("select language, count(distinct full_name) projects, sum(num_contributors) contributors
       from ds_summary 
       group by language")

tab1_kd <- sqldf("select language, count(*) as total_kds 
             from tf_ds 
             group by language")

tab1_men <- sqldf("select language, count(*) as total_male 
             from tf_ds 
             where gender_final = 'male'
             group by language")


tab1_female <- sqldf("select language, count(*) as total_female
                 from tf_ds 
                 where gender_final = 'female'
                 group by language")


tab1_unknown <- sqldf("select language, count(*) as total_unknown
                 from tf_ds 
                 where gender_final = 'unissex'
                 group by language")

tab1_total_projects_with_women <- sqldf("select language, count(distinct full_name) as total_projects_with_women
                 from tf_ds 
                 where gender_final = 'female'
                 group by language")

tab1 <- merge(tab1, tab1_kd) 

tab1 <- merge(tab1, tab1_men)


tab1 <- merge(tab1, tab1_female)

tab1 <- merge(tab1, tab1_unknown)

tab1 <- merge(tab1, tab1_total_projects_with_women)

tab1["percentage"] <- tab1$total_projects_with_women * 100 / tab1$projects

print(xtable(tab1[,c("language", "projects", "contributors", "total_kds", "total_male", "total_female", "total_unknown", "total_projects_with_women", "percentage")]), type='latex')

sum(tab1$projects)
sum(tab1$contributors)
sum(tab1$total_kds)
sum(tab1$total_male)
sum(tab1$total_female)
sum(tab1$total_unknown)
sum(tab1$total_projects_with_women)
mean(tab1$percentage)
sd(tab1$percentage)
```
